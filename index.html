<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go-Forth Lease Review System</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/mammoth@1.4.2/mammoth.browser.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Design System Variables */
        :root {
            /* Go-Forth Color Palette */
            --gf-red-primary: #C41E3A;
            --gf-red-secondary: #D63851;
            --gf-red-muted: #F5E6E8;
            --gf-blue: #2B4A8D;
            --gf-green: #10B981;
            
            /* Neutral Palette */
            --bg-primary: #FAFAFA;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F5F5F5;
            --text-primary: #0A0A0A;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-subtle: #E5E5E5;
            --border-muted: #F0F0F0;
            
            /* Shadows */
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-strong: 0 8px 24px rgba(0, 0, 0, 0.12);
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            /* Typography */
            --font-display: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-ui);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header Styles */
        .app-header {
            text-align: center;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        
        .app-header h1 {
            font-family: var(--font-display);
            font-size: clamp(1.5rem, 3vw, 2rem);
            font-weight: 400;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }
        
        .app-header .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 400;
            margin-bottom: 0;
        }
        
        /* Step Navigation */
        .step-nav {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-subtle);
            border: 1px solid var(--border-subtle);
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .progress-line {
            position: absolute;
            top: 20px; /* Half of step-number height (40px) */
            left: 2rem;
            right: 2rem;
            height: 2px;
            background: var(--border-muted);
            z-index: 1;
        }
        
        .progress-line::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: var(--gf-red-primary);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 1px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 0.875rem;
            border: 2px solid var(--gf-red-primary);
            background: var(--bg-secondary);
            color: var(--gf-red-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .step.active .step-number {
            background: var(--gf-red-primary);
            color: white;
            border-color: var(--gf-red-primary);
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
        }
        
        .step.completed .step-number {
            background: var(--gf-red-primary);
            color: white;
            border-color: var(--gf-red-primary);
        }
        
        .step-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-muted);
            text-align: center;
            transition: color 0.3s ease;
        }
        
        .step.active .step-label {
            color: var(--text-primary);
        }
        
        /* Main Content Area */
        .main-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-subtle);
            border: 1px solid var(--border-subtle);
            margin-bottom: 1rem;
            flex: 1;
        }
        
        /* Step Content Styles */
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .section-icon {
            width: 24px;
            height: 24px;
            color: var(--gf-blue);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            font-family: var(--font-heading);
        }
        
        /* Upload Interface */
        .upload-zone {
            border: 2px dashed var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 2rem 1.5rem;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--gf-red-muted);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .upload-zone:hover {
            border-color: var(--gf-red-primary);
            background: var(--gf-red-muted);
        }
        
        .upload-zone:hover::before {
            opacity: 0.3;
        }
        
        .upload-zone.dragover {
            border-color: var(--gf-red-primary);
            background: var(--gf-red-muted);
            transform: scale(1.02);
        }
        
        .upload-zone.dragover::before {
            opacity: 0.5;
        }
        
        .upload-content {
            position: relative;
            z-index: 1;
        }
        
        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }
        
        .upload-zone:hover .upload-icon {
            background: var(--gf-red-primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .upload-text {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .upload-subtext {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }
        
        #fileInput {
            display: none;
        }
        
        /* Button Styles */
        .btn {
            background: var(--gf-red-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-subtle);
            font-family: var(--font-ui);
            margin: 5px;
        }
        
        .btn:hover {
            background: var(--gf-red-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .btn-primary {
            background: var(--gf-red-primary);
        }
        
        .btn-primary:hover {
            background: var(--gf-red-secondary);
        }
        
        .btn-success {
            background: var(--gf-blue);
        }
        
        .btn-success:hover {
            background: #1d3a75;
        }
        
        .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--text-primary);
        }
        
        .upload-button {
            background: var(--gf-red-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-subtle);
            font-family: var(--font-ui);
        }
        
        .upload-button:hover {
            background: var(--gf-red-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        /* API Configuration */
        .api-config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .api-config h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .api-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
        }
        
        /* Progress Indicator */
        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFB347, #FF6B47);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: 500;
        }
        
        /* Form Styles (matching the original template) */
        .lease-form {
            background: var(--bg-secondary);
            margin: 20px 0;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-subtle);
        }
        
        .container { 
            max-width: 8.5in; 
            margin: 0 auto; 
            background: var(--bg-secondary); 
            padding: 20px; 
        }
        
        /* Professional Header */
        .press-header { 
            text-align: center; 
            background: var(--gf-blue); 
            color: white; 
            margin: -20px -20px 15px -20px; 
            padding: 15px 20px; 
        }
        
        .press-header h1 { 
            font-size: 18px; 
            font-weight: bold; 
            margin: 0; 
            color: white; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
            font-family: var(--font-heading);
        }
        
        .press-header .date-line { 
            font-size: 11px; 
            color: #e8e8e8; 
            margin-top: 4px; 
            font-style: italic; 
        }
        
        /* Form Row Styles */
        .form-row { 
            margin-bottom: 8px; 
            display: flex; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        
        .form-row.full-width { 
            flex-direction: column; 
            align-items: flex-start; 
        }
        
        .form-row-inline { 
            display: flex; 
            align-items: center; 
            flex-wrap: wrap; 
            margin-bottom: 6px; 
        }
        
        .form-row-inline label { 
            margin-right: 6px; 
        }
        
        .form-row-inline input, 
        .form-row-inline select { 
            margin-right: 15px; 
        }
        
        /* Label and Input Styles */
        label { 
            font-weight: 500; 
            color: var(--gf-blue); 
            margin-right: 8px; 
            min-width: 140px; 
            font-size: 0.875rem;
            font-family: var(--font-ui);
        }
        
        .required { 
            color: #8b0000; 
        }
        
        .optional { 
            color: #666; 
            font-weight: normal; 
        }
        
        input[type="text"], input[type="email"], input[type="tel"], 
        input[type="number"], input[type="date"], textarea, select {
            border: 1px solid var(--border-subtle); 
            padding: 6px 10px; 
            font-size: 0.875rem; 
            background: var(--bg-secondary); 
            font-family: var(--font-ui); 
            margin-right: 10px;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }
        
        input:focus, textarea:focus, select:focus { 
            border-color: var(--gf-red-primary); 
            outline: none;
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
        }
        
        .field-small { width: 80px; }
        .field-medium { width: 140px; }
        .field-large { width: 200px; }
        .field-xl { width: 350px; }
        .field-full { width: 100%; }
        
        textarea { 
            min-height: 40px; 
            resize: vertical; 
            font-family: var(--font-ui); 
            line-height: 1.2; 
        }
        
        /* Section Styling */
        .section { 
            margin-bottom: 10px; 
        }
        
        .form .section-header { 
            background: var(--gf-blue); 
            color: white; 
            padding: 8px 15px; 
            margin: 10px -15px 10px -15px; 
            border-radius: var(--radius-sm);
        }
        
        .form .section-header h2 { 
            margin: 0; 
            color: white; 
            font-size: 14px; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            font-family: var(--font-heading);
        }
        
        .form .section-header .section-desc { 
            font-size: 10px; 
            color: #e8e8e8; 
            margin-top: 2px; 
            font-style: italic; 
        }
        
        .subsection { 
            margin-bottom: 12px; 
            padding: 10px; 
            background: var(--bg-tertiary); 
            border-left: 3px solid var(--gf-blue); 
            border-radius: var(--radius-sm);
        }
        
        .subsection h3 { 
            margin: 0 0 8px 0; 
            color: var(--gf-blue); 
            font-size: 12px; 
            border-bottom: 1px solid var(--border-subtle); 
            padding-bottom: 4px; 
            font-weight: 600; 
            text-transform: uppercase; 
            font-family: var(--font-heading);
        }
        
        /* Priority Styling */
        .priority-high { 
            border-left: 4px solid var(--gf-red-primary); 
            background: var(--bg-tertiary); 
        }
        
        .priority-medium { 
            border-left: 4px solid var(--gf-blue); 
            background: var(--bg-tertiary); 
        }
        
        .priority-low { 
            border-left: 4px solid var(--text-secondary); 
            background: var(--bg-tertiary); 
        }
        
        /* Executive Summary */
        .exec-summary { 
            background: var(--gf-blue); 
            color: white; 
            padding: 12px; 
            margin-bottom: 15px; 
            border-radius: var(--radius-sm);
        }
        
        .exec-summary h2 { 
            color: white; 
            font-size: 13px; 
            margin: 0 0 8px 0; 
            font-family: var(--font-heading);
            font-weight: 600;
        }
        
        .exec-summary label { 
            color: white; 
            font-family: var(--font-ui);
        }
        
        .exec-summary .required { 
            color: var(--gf-red-muted); 
        }
        
        /* Checkbox Groups */
        .checkbox-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 4px; 
        }
        
        .checkbox-item { 
            display: flex; 
            align-items: center; 
            margin-right: 15px; 
        }
        
        .checkbox-item input[type="checkbox"], 
        .checkbox-item input[type="radio"] { 
            margin-right: 4px; 
        }
        
        .checkbox-item label { 
            min-width: auto; 
            margin-right: 0; 
            font-weight: normal; 
            font-size: 11px; 
        }
        
        /* Approval Section */
        .approval-section { 
            background: var(--gf-blue); 
            color: white; 
            padding: 12px; 
            margin-top: 15px; 
            border-radius: var(--radius-sm);
        }
        
        .approval-section h2 { 
            color: white; 
            font-size: 13px; 
            margin: 0 0 8px 0; 
            font-family: var(--font-heading);
            font-weight: 600;
        }
        
        .approval-section label { 
            color: white; 
            font-family: var(--font-ui);
        }
        
        .approval-section .required { 
            color: var(--gf-red-muted); 
        }
        
        /* Field Help Text */
        .field-help { 
            font-size: 9px; 
            color: #666; 
            font-style: italic; 
            margin-top: 2px; 
            line-height: 1.2; 
        }
        
        /* Alert/Status Messages */
        .alert {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            border: 1px solid;
            font-weight: 500;
        }
        
        .alert-info {
            background: #f0f9ff;
            border-color: var(--gf-blue);
            color: var(--gf-blue);
        }
        
        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .alert-success {
            background: #f0f9ff;
            border-color: var(--gf-blue);
            color: var(--gf-blue);
        }
        
        .alert-danger {
            background: #fef2f2;
            border-color: var(--gf-red-primary);
            color: #991b1b;
        }
        
        /* Features Grid */
        .features-grid {
            margin-top: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .feature-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 1rem;
            border: 1px solid var(--border-muted);
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            background: var(--bg-secondary);
            border-color: var(--border-subtle);
            transform: translateY(-2px);
            box-shadow: var(--shadow-subtle);
        }
        
        .feature-icon {
            width: 20px;
            height: 20px;
            color: var(--gf-blue);
            margin-bottom: 0.5rem;
        }
        
        .feature-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .feature-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1f3a93;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-3 { margin-top: 1rem; }
        .mb-3 { margin-bottom: 1rem; }
        
        /* Responsive Design */
        /* Large screens - reduce max width further */
        @media (min-width: 1400px) {
            .app-container {
                max-width: 1200px;
            }
        }
        
        /* Medium screens - laptops */
        @media (max-width: 1200px) {
            .app-container {
                max-width: 900px;
                padding: 1rem;
            }
        }
        
        /* Small laptops and tablets */
        @media (max-width: 992px) {
            .app-container {
                max-width: 100%;
                padding: 1rem;
            }
            
            .app-header {
                margin-bottom: 1rem;
            }
            
            .step-nav {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .main-content {
                padding: 1.25rem;
            }
        }
        
        /* Tablets and small screens */
        @media (max-width: 768px) {
            .app-container {
                padding: 0.75rem;
            }
            
            .app-header h1 {
                font-size: 1.5rem;
            }
            
            .app-header .subtitle {
                font-size: 0.85rem;
            }
            
            .step-nav {
                padding: 0.75rem;
            }
            
            .progress-steps {
                gap: 0.5rem;
            }
            
            .step-label {
                font-size: 0.65rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .upload-zone {
                padding: 1.5rem 1rem;
                min-height: 160px;
            }
            
            .upload-icon {
                width: 40px;
                height: 40px;
            }
            
            .form-row-inline {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-row-inline input,
            .form-row-inline select {
                margin-bottom: 10px;
                width: 100%;
            }
        }
        
        /* Mobile phones */
        @media (max-width: 480px) {
            .app-container {
                padding: 0.5rem;
            }
            
            .app-header h1 {
                font-size: 1.25rem;
            }
            
            .step-label {
                display: none;
            }
            
            .step-nav {
                padding: 0.5rem;
            }
            
            .main-content {
                padding: 0.75rem;
            }
            
            .upload-zone {
                padding: 1rem;
                min-height: 140px;
            }
        }
        
        /* Print Styles */
        @media print {
            .app-header, .step-nav, .btn, .api-config {
                display: none;
            }
            
            .main-content {
                box-shadow: none;
                border: none;
            }
            
            body { 
                margin: 0.5in; 
                font-size: 11px; 
            }
            
            .container { 
                padding: 0; 
            }
            
            .press-header { 
                margin: 0 0 10px 0; 
            }
            
            .section { 
                page-break-inside: avoid; 
            }
            
            .subsection { 
                page-break-inside: avoid; 
            }
        }
        
        /* PDF Generation Specific Styles */
        .pdf-container {
            width: 8.5in !important;
            background: white !important;
            font-family: 'Times New Roman', Times, serif !important;
            font-size: 11px !important;
            line-height: 1.3 !important;
            color: #333 !important;
        }
        
        .pdf-container .press-header {
            background: #1f3a93 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .pdf-container .section-header {
            background: #1f3a93 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .pdf-container .exec-summary {
            background: #1f3a93 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .pdf-container .approval-section {
            background: #1f3a93 !important;
            color: white !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .pdf-container .priority-high {
            border-left: 4px solid #8b0000 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .pdf-container .priority-medium {
            border-left: 4px solid #1f3a93 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .pdf-container .subsection {
            border-left: 3px solid #1f3a93 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <header class="app-header">
            <h1>Go-Forth Lease Review</h1>
            <p class="subtitle">AI-Powered Commercial Lease Analysis & Risk Assessment</p>
        </header>
        
        <!-- Step Navigation -->
        <div class="step-nav">
            <div class="progress-steps">
                <div class="progress-line"></div>
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <span class="step-label">Upload Lease</span>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <span class="step-label">AI Analysis</span>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <span class="step-label">Review & Edit</span>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <span class="step-label">Download Report</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Step 1: Upload Interface -->
            <div class="step-content active" id="step1">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10,9 9,9 8,9"></polyline>
                    </svg>
                    <h2 class="section-title">Upload Lease Document</h2>
                </div>
                
                <!-- API Configuration (Hidden - pre-configured) -->
                <div class="api-config hidden">
                    <h3>🔑 OpenAI API Configuration</h3>
                    <p>Enter your OpenAI API key to enable AI-powered lease analysis:</p>
                    <input type="password" id="apiKey" class="api-input" placeholder="sk-..." />
                    <p style="font-size: 0.9em; color: #666;">Your API key is stored locally and never transmitted to our servers.</p>
                </div>
                
                <!-- Upload Zone -->
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".pdf,.docx,.doc" />
                    <div class="upload-content">
                        <div class="upload-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7,10 12,15 17,10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </div>
                        <div class="upload-text">Click to select lease document or drag & drop here</div>
                        <div class="upload-subtext">Supports PDF, Word (.docx/.doc) files or paste text directly</div>
                        <button class="upload-button">Select Document</button>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-secondary" onclick="showTextInput()">Or Paste Lease Text</button>
                </div>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <svg class="feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12l2 2 4-4"></path>
                            <circle cx="12" cy="12" r="9"></circle>
                        </svg>
                        <div class="feature-title">Instant Analysis</div>
                        <div class="feature-desc">AI processes your lease in under 30 seconds</div>
                    </div>
                    <div class="feature-card">
                        <svg class="feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                        </svg>
                        <div class="feature-title">Risk Assessment</div>
                        <div class="feature-desc">Identifies potential issues and red flags</div>
                    </div>
                    <div class="feature-card">
                        <svg class="feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                        </svg>
                        <div class="feature-title">Detailed Reports</div>
                        <div class="feature-desc">Comprehensive analysis with actionable insights</div>
                    </div>
                </div>
                
                <!-- Text Input Alternative -->
                <div id="textInputArea" class="hidden" style="margin-top: 20px;">
                    <h3>📝 Paste Lease Text</h3>
                    <textarea id="leaseText" style="width: 100%; height: 200px; padding: 10px;" 
                              placeholder="Paste the lease agreement text here..."></textarea>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" onclick="processTextInput()">Process Text</button>
                        <button class="btn btn-secondary" onclick="hideTextInput()">Cancel</button>
                    </div>
                </div>
                
                <!-- Progress Container -->
                <div class="progress-container hidden" id="uploadProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Processing document...</div>
                </div>
                
                <!-- Status Messages -->
                <div id="statusMessages"></div>
            </div>
            
            <!-- Step 2: AI Analysis -->
            <div class="step-content" id="step2">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    <h2 class="section-title">AI Analysis in Progress</h2>
                </div>
                
                <div class="alert alert-info">
                    <strong>Chris Caldwell is reviewing your lease...</strong><br>
                    Our AI legal expert is analyzing the document against Go-Forth Pest Control's lease review policy.
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="analysisProgress"></div>
                    </div>
                    <div class="progress-text" id="analysisText">Initializing AI analysis...</div>
                </div>
                
                <div id="analysisStatus"></div>
            </div>
            
            <!-- Step 3: Review & Edit Form -->
            <div class="step-content" id="step3">
                <div class="section-header">
                    <h2 class="section-title">Review Analysis & Edit Form</h2>
                </div>
                
                <div class="alert alert-success">
                    <strong>Analysis Complete!</strong> Review the extracted information and proposed changes below.
                </div>
                
                <!-- The complete lease review form will be inserted here -->
                <div id="leaseReviewForm"></div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-primary" onclick="goToStep(4)">Generate Final Report</button>
                    <button class="btn btn-secondary" onclick="reAnalyze()">Re-analyze with AI</button>
                </div>
            </div>
            
            <!-- Step 4: Download & Export -->
            <div class="step-content" id="step4">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7,10 12,15 17,10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <h2 class="section-title">Download & Export</h2>
                </div>
                
                <div class="alert alert-success">
                    <strong>Report Ready!</strong> Your lease review analysis is complete and ready for download.
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                        <h3 style="color: #1f3a93;">📄 PDF Report</h3>
                        <p>Professional lease review report for internal use and CFO approval.</p>
                        <button class="btn btn-primary" onclick="downloadPDF()">Download PDF</button>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                        <h3 style="color: #1f3a93;">📧 Broker Response</h3>
                        <p>Professionally formatted change requests to send to the broker.</p>
                        <button class="btn btn-success" onclick="copyBrokerResponse()">Copy to Clipboard</button>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                        <h3 style="color: #1f3a93;">☁️ Save to Drive</h3>
                        <p>Save the complete analysis to your Google Drive for future reference.</p>
                        <button class="btn btn-secondary" onclick="saveToGoogleDrive()">Save to Drive</button>
                    </div>
                </div>
                
                <div id="brokerResponsePreview" class="hidden">
                    <h3>Broker Response Preview:</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; white-space: pre-wrap;" id="brokerResponseText"></div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-secondary" onclick="startOver()">Start New Review</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let leaseContent = '';
        let extractedData = {};
        let analysisResults = {};
        let apiKey = '';
        
        // PDF.js configuration
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadSavedApiKey();
        });
        
        function setupEventListeners() {
            // File input change handler
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // Drag and drop handlers
            const uploadZone = document.querySelector('.upload-zone');
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleFileDrop);
            
            // API key input handler
            document.getElementById('apiKey').addEventListener('input', function() {
                apiKey = this.value;
                localStorage.setItem('openai_api_key', apiKey);
            });
        }
        
        function loadSavedApiKey() {
            // Pre-populate with provided API key (complete key from user)
            const providedKey = '';
            apiKey = providedKey;
            
            // Store it for future use
            localStorage.setItem('openai_api_key', providedKey);
        }
        
        // Step navigation functions
        function goToStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all step indicators
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
                if (parseInt(step.dataset.step) < stepNumber) {
                    step.classList.add('completed');
                }
            });
            
            // Show target step
            document.getElementById(`step${stepNumber}`).classList.add('active');
            document.querySelector(`.step[data-step="${stepNumber}"]`).classList.add('active');
            
            // Update progress line
            updateProgressLine(stepNumber);
            
            currentStep = stepNumber;
        }
        
        function updateProgressLine(stepNumber) {
            const progressLine = document.querySelector('.progress-line::after');
            const percentage = ((stepNumber - 1) / 3) * 100; // 4 steps total, so 3 intervals
            
            // Use CSS custom property to update the progress
            document.documentElement.style.setProperty('--progress-width', percentage + '%');
            
            // If the pseudo-element approach doesn't work, try direct manipulation
            const style = document.createElement('style');
            style.textContent = `.progress-line::after { width: ${percentage}% !important; }`;
            document.head.appendChild(style);
            
            // Clean up old style elements
            setTimeout(() => {
                const oldStyles = document.querySelectorAll('head style');
                if (oldStyles.length > 5) { // Keep only last 5 style elements
                    oldStyles[0].remove();
                }
            }, 1000);
        }
        
        // File handling functions
        function handleDragOver(e) {
            e.preventDefault();
            e.target.closest('.upload-zone').classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.target.closest('.upload-zone').classList.remove('dragover');
        }
        
        function handleFileDrop(e) {
            e.preventDefault();
            const uploadZone = e.target.closest('.upload-zone');
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        async function processFile(file) {
            if (!validateApiKey()) return;
            
            showProgress('uploadProgress');
            updateProgress('progressFill', 'progressText', 10, 'Reading file...');
            
            try {
                if (file.type === 'application/pdf') {
                    leaseContent = await extractTextFromPDF(file);
                } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                          file.type === 'application/msword' ||
                          file.name.toLowerCase().endsWith('.docx') ||
                          file.name.toLowerCase().endsWith('.doc')) {
                    leaseContent = await extractTextFromWord(file);
                } else {
                    throw new Error('Unsupported file type. Please upload a PDF or Word document (.pdf, .docx, .doc).');
                }
                
                updateProgress('progressFill', 'progressText', 100, 'File processed successfully!');
                
                setTimeout(() => {
                    hideProgress('uploadProgress');
                    goToStep(2);
                    startAIAnalysis();
                }, 1000);
                
            } catch (error) {
                showError('Failed to process file: ' + error.message);
                hideProgress('uploadProgress');
            }
        }
        
        async function extractTextFromPDF(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const typedarray = new Uint8Array(e.target.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = '';
                        
                        for (let i = 1; i <= pdf.numPages; i++) {
                            updateProgress('progressFill', 'progressText', 
                                20 + (i / pdf.numPages) * 60, 
                                `Extracting text from page ${i} of ${pdf.numPages}...`);
                            
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n\n';
                        }
                        
                        resolve(fullText);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsArrayBuffer(file);
            });
        }
        
        async function extractTextFromWord(file) {
            return new Promise((resolve, reject) => {
                updateProgress('progressFill', 'progressText', 30, 'Processing Word document...');
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        
                        updateProgress('progressFill', 'progressText', 60, 'Extracting text from Word document...');
                        
                        // Use Mammoth.js to extract text from Word document
                        const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                        const text = result.value;
                        
                        if (!text || text.trim().length === 0) {
                            throw new Error('No text content found in the Word document. The document may be empty or contain only images/formatting.');
                        }
                        
                        updateProgress('progressFill', 'progressText', 90, 'Word document processing complete...');
                        resolve(text);
                        
                    } catch (error) {
                        console.error('Word extraction error:', error);
                        reject(new Error('Failed to extract text from Word document: ' + error.message));
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('Failed to read Word document file'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Text input functions
        function showTextInput() {
            document.getElementById('textInputArea').classList.remove('hidden');
        }
        
        function hideTextInput() {
            document.getElementById('textInputArea').classList.add('hidden');
            document.getElementById('leaseText').value = '';
        }
        
        function processTextInput() {
            if (!validateApiKey()) return;
            
            const text = document.getElementById('leaseText').value.trim();
            if (!text) {
                showError('Please enter the lease text before processing.');
                return;
            }
            
            leaseContent = text;
            hideTextInput();
            goToStep(2);
            startAIAnalysis();
        }
        
        // AI Analysis functions
        async function startAIAnalysis() {
            showProgress('analysisProgress');
            updateAnalysisProgress(10, 'Initializing AI analysis...');
            
            try {
                updateAnalysisProgress(30, 'Sending the lease to Chris...');
                
                const analysis = await performAIAnalysis(leaseContent);
                
                updateAnalysisProgress(80, 'Processing analysis results...');
                
                analysisResults = analysis;
                populateLeaseForm(analysis);
                
                updateAnalysisProgress(100, 'Analysis complete!');
                
                setTimeout(() => {
                    goToStep(3);
                }, 1500);
                
            } catch (error) {
                showError('AI Analysis failed: ' + error.message);
                document.getElementById('analysisStatus').innerHTML = 
                    '<div class="alert alert-danger">Analysis failed. Please check your API key and try again.</div>';
            }
        }
        
        async function performAIAnalysis(leaseText) {
            if (!apiKey) {
                throw new Error('OpenAI API key is required');
            }
            
            console.log('API Key being used:', apiKey.substring(0, 20) + '...');
            
            const prompt = createAnalysisPrompt(leaseText);
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini', // Using gpt-4o-mini for better availability
                    messages: [
                        {
                            role: 'system',
                            content: getChrisCaldwellPersona()
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 4000,
                    temperature: 0.3
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error(`OpenAI API error: ${response.status} ${response.statusText}. Details: ${errorText}`);
            }
            
            const data = await response.json();
            console.log('API Response received successfully');
            const analysisContent = data.choices[0].message.content;
            
            // Parse the AI response into structured data
            return parseAIAnalysis(analysisContent);
        }
        
        function createAnalysisPrompt(leaseText) {
            const leasePolicy = getLeasePolicy();
            
            return `
You are Chris Caldwell, reviewing this lease for Go-Forth Pest Control. Please analyze this lease document against our company policy and extract all key information.

LEASE DOCUMENT:
${leaseText}

COMPANY POLICY:
${leasePolicy}

Please provide a comprehensive analysis in the following JSON format. IMPORTANT: Look carefully for ALL lease details including fees, charges, HOA information, parking details, and additional obligations:

{
    "extractedData": {
        "landlordName": "Complete legal name of landlord entity",
        "landlordContact": "Individual contact person name",
        "landlordEmail": "Contact email address",
        "landlordPhone": "Contact phone number",
        "landlordAddress": "Complete mailing address for notices",
        "tenantName": "Tenant legal entity name",
        "propertyAddress": "Complete property address with suite/unit",
        "squareFootage": "Number in sq ft",
        "leaseStartDate": "YYYY-MM-DD format",
        "leaseTerm": "Number of months",
        "monthlyRent": "Base monthly rent amount",
        "securityDeposit": "Security deposit amount",
        "lateFee": "Late fee amount or percentage",
        "annualIncrease": "Annual rent increase percentage",
        "paymentDueDate": "When rent is due each month",
        "paymentMethods": ["check", "ach", "online", etc],
        "additionalFees": "CAM charges, utilities, maintenance fees, etc - be specific",
        "additionalRentObligations": "Property taxes, insurance, escalations - be detailed",
        "nnnLease": "true/false - does tenant pay taxes, insurance, maintenance",
        "renewalOption": "true/false",
        "renewalTerm": "Renewal term in years",
        "personalGuarantee": "Detailed description of guarantee requirements",
        "hoaExists": "true/false",
        "hoaName": "Name of HOA if exists",
        "hoaFees": "Monthly/annual HOA fee amount",
        "hoaFeesPaidBy": "landlord/tenant/shared",
        "hoaContactRules": "HOA contact info and any restrictions",
        "parkingSpaces": "Number of spaces allocated",
        "parkingAllocation": "Detailed parking terms, overnight rules, restrictions",
        "hvacStatus": "HVAC/AC condition and responsibilities"
    },
    "policyViolations": {
        "critical": ["List any deal-breaker violations"],
        "important": ["List financial/operational violations"],
        "preferred": ["List preferred term violations"],
        "technical": ["List technical preference violations"]
    },
    "recommendedChanges": [
        {
            "priority": "critical|important|preferred|technical",
            "item": "Specific change needed - be concise and actionable",
            "rationale": "Business reason for the change",
            "brokerLanguage": "Professional language to send to broker"
        }
    ],
    "overallRecommendation": "approve|negotiate|reject",
    "executiveSummary": "Brief summary of key issues and recommendation"
}

CRITICAL: Please ensure you extract ALL available information from the lease, even if some fields may be blank or not mentioned. Look specifically for:
- Any mention of additional fees, charges, or expenses
- HOA information, rules, or fees
- Parking details, overnight restrictions, or space allocations
- Additional rent obligations beyond base rent
- Triple net lease terms (NNN)
- Personal guarantee requirements

Be thorough in your analysis and ensure all policy violations are identified with appropriate priority levels.
            `;
        }
        
        function parseAIAnalysis(analysisContent) {
            try {
                // Try to extract JSON from the AI response
                const jsonMatch = analysisContent.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                } else {
                    // If no JSON found, create a basic structure
                    return {
                        extractedData: {},
                        policyViolations: {
                            critical: [],
                            important: [],
                            preferred: [],
                            technical: []
                        },
                        recommendedChanges: [],
                        overallRecommendation: 'negotiate',
                        executiveSummary: 'Analysis completed. Please review the recommendations.'
                    };
                }
            } catch (error) {
                console.error('Failed to parse AI analysis:', error);
                // Return basic structure if parsing fails
                return {
                    extractedData: {},
                    policyViolations: {
                        critical: [],
                        important: [],
                        preferred: [],
                        technical: []
                    },
                    recommendedChanges: [{
                        priority: 'important',
                        item: 'Manual review required',
                        rationale: 'AI analysis needs manual verification',
                        brokerLanguage: 'Please provide additional lease details for complete review.'
                    }],
                    overallRecommendation: 'negotiate',
                    executiveSummary: 'Manual review required due to analysis parsing issues.'
                };
            }
        }
        
        // Form population functions
        function populateLeaseForm(analysis) {
            const formHTML = generateLeaseFormHTML(analysis);
            document.getElementById('leaseReviewForm').innerHTML = formHTML;
            
            // Populate form fields with extracted data
            if (analysis.extractedData) {
                populateFormFields(analysis.extractedData);
            }
            
            // Populate recommended changes
            if (analysis.recommendedChanges) {
                populateRecommendedChanges(analysis.recommendedChanges);
            }
        }
        
        function generateLeaseFormHTML(analysis) {
            const today = new Date().toISOString().split('T')[0];
            
            return `
                <div class="lease-form">
                    <div class="container">
                        <!-- Press Release Style Header -->
                        <div class="press-header">
                            <h1>COMMERCIAL LEASE REVIEW - TENANT</h1>
                            <div class="date-line"><em>Confidential document for internal review only</em></div>
                        </div>

                        <!-- Basic Information -->
                        <div class="form-row-inline">
                            <label>Report Date: <span class="required">*</span></label>
                            <input type="date" class="field-medium" id="reportDate" value="${today}" required>
                        </div>

                        <!-- Executive Summary -->
                        <div class="exec-summary">
                            <h2>Executive Summary</h2>
                            
                            <div class="form-row-inline">
                                <label>Property Name: <span class="required">*</span></label>
                                <input type="text" class="field-large" id="propertyName" placeholder="Building/Property Name" required>
                                <label>Location: <span class="required">*</span></label>
                                <input type="text" class="field-medium" id="location" placeholder="City, State" required>
                            </div>
                            
                            <div class="form-row-inline">
                                <label>Review Status: <span class="required">*</span></label>
                                <select class="field-medium" id="reviewStatus" required>
                                    <option value="">Select Status</option>
                                    <option value="initial" selected>Initial Review</option>
                                    <option value="revised">Revised Review</option>
                                    <option value="final">Final Review</option>
                                    <option value="amendment">Amendment Review</option>
                                </select>
                                <label>Recommendation: <span class="required">*</span></label>
                                <select class="field-large" id="recommendation" required>
                                    <option value="">Select Recommendation</option>
                                    <option value="approve">Approve as Written</option>
                                    <option value="approve-changes">Approve with Minor Changes</option>
                                    <option value="negotiate" selected>Requires Negotiation</option>
                                    <option value="reject">Recommend Rejection</option>
                                </select>
                            </div>
                        </div>

                        <!-- Section 1: Lease Information -->
                        <div class="section">
                            <div class="section-header">
                                <h2>Section 1: Extracted Lease Information</h2>
                                <div class="section-desc">Key terms and conditions extracted from the lease agreement</div>
                            </div>

                            <!-- Party Information -->
                            <div class="subsection">
                                <h3>Party Information</h3>
                                
                                <div class="form-row-inline">
                                    <label>Landlord Legal Entity: <span class="required">*</span></label>
                                    <input type="text" class="field-xl" id="landlordName" placeholder="Complete legal name as appears on lease" required>
                                </div>
                                
                                <div class="form-row-inline">
                                    <label>Landlord Contact:</label>
                                    <input type="text" class="field-large" id="landlordContact" placeholder="Primary contact person">
                                    <label>Email:</label>
                                    <input type="email" class="field-large" id="landlordEmail" placeholder="contact@landlord.com">
                                </div>
                                
                                <div class="form-row-inline">
                                    <label>Landlord Phone:</label>
                                    <input type="tel" class="field-medium" id="landlordPhone" placeholder="(555) 123-4567">
                                </div>
                                
                                <div class="form-row-inline">
                                    <label>Tenant Legal Entity: <span class="required">*</span></label>
                                    <input type="text" class="field-xl" id="tenantName" placeholder="Your company's complete legal name" required>
                                </div>
                                
                                <div class="form-row full-width">
                                    <label>Landlord Mailing Address: <span class="required">*</span></label>
                                    <textarea class="field-full" id="landlordAddress" placeholder="Complete mailing address for notices and payments" required></textarea>
                                </div>
                            </div>

                            <!-- Lease Terms -->
                            <div class="subsection priority-high">
                                <h3>Critical Lease Terms</h3>
                                
                                <div class="form-row-inline">
                                    <label style="min-width: 135px;">Lease Start Date: <span class="required">*</span></label>
                                    <input type="date" class="field-medium" id="leaseStartDate" required>
                                    <label style="min-width: 100px; margin-left: 15px;">Lease Term: <span class="required">*</span></label>
                                    <input type="number" class="field-small" id="leaseTerm" required> months
                                </div>
                                
                                <div class="form-row-inline">
                                    <label style="min-width: 135px;">Base Monthly Rent: <span class="required">*</span></label>
                                    $<input type="number" class="field-medium" id="monthlyRent" placeholder="0.00" step="0.01" required>
                                    <label style="min-width: 100px; margin-left: 10px;">Security Deposit:</label>
                                    $<input type="number" class="field-small" id="securityDeposit" placeholder="0.00" step="0.01">
                                </div>
                                
                                <div class="form-row-inline">
                                    <label style="min-width: 135px;">Late Fee:</label>
                                    $<input type="number" class="field-medium" id="lateFee" placeholder="0.00" step="0.01">
                                    <label style="min-width: 100px; margin-left: 10px;">Annual Increase:</label>
                                    <input type="number" class="field-small" id="annualIncrease" placeholder="0.0" step="0.1">%
                                </div>
                                
                                <div class="form-row-inline">
                                    <label style="min-width: 135px;">Payment Due Date:</label>
                                    <select class="field-medium" id="paymentDueDate">
                                        <option value="">Select</option>
                                        <option value="1st">1st of month</option>
                                        <option value="15th">15th of month</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <label style="min-width: 100px; margin-left: 10px;">Payment Method:</label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item"><input type="checkbox" id="paymentCheck"><label for="paymentCheck">Check</label></div>
                                        <div class="checkbox-item"><input type="checkbox" id="paymentACH"><label for="paymentACH">ACH/Wire</label></div>
                                        <div class="checkbox-item"><input type="checkbox" id="paymentOnline"><label for="paymentOnline">Online Portal</label></div>
                                    </div>
                                </div>
                                
                                <div class="form-row full-width">
                                    <label>Additional Fees & Charges:</label>
                                    <textarea class="field-full" id="additionalFees" placeholder="CAM charges, utilities, maintenance fees, etc."></textarea>
                                </div>
                            </div>

                            <!-- Financial Structure -->
                            <div class="subsection priority-high">
                                <h3>Financial Structure</h3>
                                
                                <div class="form-row-inline">
                                    <label>Triple Net Lease (NNN): <span class="required">*</span></label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item"><input type="radio" name="nnn" value="yes" id="nnn_yes"><label for="nnn_yes">Yes</label></div>
                                        <div class="checkbox-item"><input type="radio" name="nnn" value="no" id="nnn_no"><label for="nnn_no">No</label></div>
                                        <div class="checkbox-item"><input type="radio" name="nnn" value="modified" id="nnn_mod"><label for="nnn_mod">Modified</label></div>
                                    </div>
                                    <label>Hold-Over Penalty:</label>
                                    <input type="number" class="field-small" id="holdOverPenalty" placeholder="150">% of monthly rent
                                </div>
                                <div class="field-help">NNN means tenant pays property taxes, insurance, and maintenance in addition to base rent</div>
                                
                                <div class="form-row full-width">
                                    <label>Personal Guarantee Details:</label>
                                    <textarea class="field-full" id="personalGuarantee" placeholder="Required? By whom? What amount/percentage? Any limitations?"></textarea>
                                </div>
                                
                                <div class="form-row full-width">
                                    <label>Additional Rent Obligations:</label>
                                    <textarea class="field-full" id="additionalRentObligations" placeholder="CAM charges, escalations, tax increases, insurance premiums, etc."></textarea>
                                </div>
                            </div>

                            <!-- Property Details -->
                            <div class="subsection">
                                <h3>Property Details</h3>
                                
                                <div class="form-row full-width">
                                    <label>Leased Property Address: <span class="required">*</span></label>
                                    <textarea class="field-full" id="propertyAddress" placeholder="Complete property address including suite/unit numbers" required></textarea>
                                </div>
                                
                                <div class="form-row-inline">
                                    <label>Total Square Footage: <span class="required">*</span></label>
                                    <input type="number" class="field-medium" id="squareFootage" placeholder="0" required> sq ft
                                </div>
                                
                                <div class="form-row full-width">
                                    <label>Parking Allocation:</label>
                                    <textarea class="field-full" id="parkingAllocation" placeholder="Number of spaces, location, assigned vs. unassigned, restrictions"></textarea>
                                </div>
                            </div>

                            <!-- HOA Information -->
                            <div class="subsection">
                                <h3>Homeowners Association (HOA)</h3>
                                
                                <div class="form-row-inline">
                                    <label>HOA Exists: <span class="required">*</span></label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item"><input type="radio" name="hoa_exists" value="yes" id="hoa_yes"><label for="hoa_yes">Yes</label></div>
                                        <div class="checkbox-item"><input type="radio" name="hoa_exists" value="no" id="hoa_no"><label for="hoa_no">No</label></div>
                                    </div>
                                </div>
                                
                                <div class="form-row-inline">
                                    <label>HOA Name:</label>
                                    <input type="text" class="field-large" id="hoaName" placeholder="Homeowners Association Name">
                                    <label style="margin-left: 20px;">Monthly HOA Fees:</label>
                                    $<input type="number" class="field-medium" id="hoaFees" placeholder="0.00"> per month
                                </div>
                                
                                <div class="form-row-inline">
                                    <label>HOA Fees Paid by:</label>
                                    <select class="field-medium" id="hoaFeesPaidBy">
                                        <option value="">Select</option>
                                        <option value="landlord">Landlord</option>
                                        <option value="tenant">Tenant</option>
                                        <option value="shared">Shared</option>
                                    </select>
                                </div>
                                
                                <div class="form-row full-width">
                                    <label>HOA Contact & Rules:</label>
                                    <textarea class="field-full" id="hoaContactRules" placeholder="Contact information and any relevant HOA restrictions or requirements"></textarea>
                                </div>
                            </div>

                            <!-- Renewal & Assignment -->
                            <div class="subsection priority-medium">
                                <h3>Renewal & Assignment Rights</h3>
                                
                                <div class="form-row-inline">
                                    <label>Renewal Option: <span class="required">*</span></label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item"><input type="radio" name="renewal" value="yes" id="renewal_yes"><label for="renewal_yes">Yes</label></div>
                                        <div class="checkbox-item"><input type="radio" name="renewal" value="no" id="renewal_no"><label for="renewal_no">No</label></div>
                                    </div>
                                    <label style="margin-left: 30px;">Renewal Term:</label>
                                    <input type="number" class="field-small" id="renewalTerm" placeholder="0"> years
                                </div>
                                
                                <div class="form-row full-width">
                                    <label>Assignment/Subletting Rights:</label>
                                    <textarea class="field-full" id="assignmentRights" placeholder="Permitted? Requires landlord consent? Any restrictions or fees?"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Proposed Changes -->
                        <div class="section">
                            <div class="section-header">
                                <h2>Section 2: Requested Changes & Proposed Edits</h2>
                                <div class="section-desc">Modifications to be negotiated with landlord/broker</div>
                            </div>

                            <div class="subsection priority-high">
                                <h3>Proposed Changes</h3>
                                
                                <div class="form-row full-width">
                                    <label>Requested Modifications:</label>
                                    <textarea class="field-full" style="min-height: 200px;" id="requestedChanges" placeholder="• List all requested changes in bullet point format&#10;• Include business rationale for each change&#10;• Prioritize items from most critical to least critical&#10;• Example: • Reduce security deposit from 2 months to 1 month rent to improve cash flow"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Approval Section -->
                        <div class="approval-section">
                            <h2>CFO Approval Section</h2>
                            
                            <div class="form-row-inline">
                                <label>CFO Decision: <span class="required">*</span></label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item"><input type="radio" name="cfo_decision" value="approved" id="app"><label for="app">Approved</label></div>
                                    <div class="checkbox-item"><input type="radio" name="cfo_decision" value="conditional" id="cond"><label for="cond">Approved with Conditions</label></div>
                                    <div class="checkbox-item"><input type="radio" name="cfo_decision" value="revision" id="rev"><label for="rev">Requires Revision</label></div>
                                    <div class="checkbox-item"><input type="radio" name="cfo_decision" value="rejected" id="rej"><label for="rej">Rejected</label></div>
                                </div>
                            </div>
                            
                            <div class="form-row-inline">
                                <label>CFO Signature:</label>
                                <input type="text" class="field-large" id="cfoSignature" placeholder="Digital signature or printed name">
                                <label>Date:</label>
                                <input type="date" class="field-medium" id="cfoDate">
                            </div>
                            
                            <div class="form-row full-width">
                                <label>CFO Comments & Conditions:</label>
                                <textarea class="field-full" id="cfoComments" placeholder="Additional requirements, concerns, or approval conditions"></textarea>
                            </div>
                        </div>

                        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #666; font-size: 10px; color: #666; text-align: center;">
                            <p><em>This report contains confidential and proprietary information.</em></p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function populateFormFields(data) {
            // Populate form fields with extracted data
            const fieldMappings = {
                'landlordName': data.landlordName || '',
                'landlordContact': data.landlordContact || '',
                'landlordEmail': data.landlordEmail || '',
                'landlordPhone': data.landlordPhone || '',
                'landlordAddress': data.landlordAddress || '',
                'tenantName': data.tenantName || 'Go-Forth Pest Control, Inc.',
                'propertyAddress': data.propertyAddress || '',
                'squareFootage': data.squareFootage || '',
                'leaseStartDate': data.leaseStartDate || '',
                'leaseTerm': data.leaseTerm || '',
                'monthlyRent': data.monthlyRent || '',
                'securityDeposit': data.securityDeposit || '',
                'lateFee': data.lateFee || '',
                'annualIncrease': data.annualIncrease || '',
                'paymentDueDate': data.paymentDueDate || '',
                'additionalFees': data.additionalFees || '',
                'additionalRentObligations': data.additionalRentObligations || '',
                'personalGuarantee': data.personalGuarantee || '',
                'hoaName': data.hoaName || '',
                'hoaFees': data.hoaFees || '',
                'hoaFeesPaidBy': data.hoaFeesPaidBy || '',
                'hoaContactRules': data.hoaContactRules || '',
                'parkingSpaces': data.parkingSpaces || '',
                'parkingAllocation': data.parkingAllocation || '',
                'holdOverPenalty': data.holdOverPenalty || '',
                'renewalTerm': data.renewalTerm || '',
                'assignmentRights': data.assignmentRights || ''
            };
            
            // Set form field values
            Object.keys(fieldMappings).forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = fieldMappings[fieldId];
                }
            });
            
            // Set boolean/radio values
            if (data.nnnLease !== undefined) {
                const nnnValue = data.nnnLease ? 'yes' : 'no';
                const nnnRadio = document.querySelector(`input[name="nnn"][value="${nnnValue}"]`);
                if (nnnRadio) nnnRadio.checked = true;
            }
            
            if (data.hoaExists !== undefined) {
                const hoaValue = data.hoaExists ? 'yes' : 'no';
                const hoaRadio = document.querySelector(`input[name="hoa_exists"][value="${hoaValue}"]`);
                if (hoaRadio) hoaRadio.checked = true;
            }
            
            if (data.renewalOption !== undefined) {
                const renewalValue = data.renewalOption ? 'yes' : 'no';
                const renewalRadio = document.querySelector(`input[name="renewal"][value="${renewalValue}"]`);
                if (renewalRadio) renewalRadio.checked = true;
            }
            
            // Set payment method checkboxes
            if (data.paymentMethods && Array.isArray(data.paymentMethods)) {
                data.paymentMethods.forEach(method => {
                    const checkbox = document.getElementById(`payment${method.charAt(0).toUpperCase() + method.slice(1)}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Set property name and location based on address
            if (data.propertyAddress) {
                const addressParts = data.propertyAddress.split(',');
                if (addressParts.length >= 2) {
                    const propertyNameEl = document.getElementById('propertyName');
                    const locationEl = document.getElementById('location');
                    if (propertyNameEl) propertyNameEl.value = addressParts[0].trim();
                    if (locationEl) locationEl.value = addressParts.slice(-2).join(',').trim();
                }
            }
        }
        
        function populateRecommendedChanges(changes) {
            const changesTextarea = document.getElementById('requestedChanges');
            if (!changesTextarea || !changes.length) return;
            
            let changeText = '';
            
            // Group changes by priority
            const priorities = ['critical', 'important', 'preferred', 'technical'];
            const groupedChanges = {};
            
            changes.forEach(change => {
                const priority = change.priority || 'important';
                if (!groupedChanges[priority]) {
                    groupedChanges[priority] = [];
                }
                groupedChanges[priority].push(change);
            });
            
            // Format changes by priority with each item on separate lines
            priorities.forEach(priority => {
                if (groupedChanges[priority] && groupedChanges[priority].length > 0) {
                    const priorityLabel = priority.toUpperCase();
                    changeText += `${priorityLabel} ITEMS:\n`;
                    
                    groupedChanges[priority].forEach(change => {
                        changeText += `• ${change.item}\n`;
                        if (change.rationale) {
                            changeText += `  Rationale: ${change.rationale}\n`;
                        }
                        changeText += '\n'; // Add extra line break between items
                    });
                }
            });
            
            changesTextarea.value = changeText;
        }
        
        // Export and download functions
        async function downloadPDF() {
            try {
                showInfo('Generating PDF report...');
                
                // Create a clean, filled form for PDF generation
                const filledFormHTML = generateFilledFormHTML();
                
                // Create a temporary container for PDF generation
                const pdfContainer = document.createElement('div');
                pdfContainer.innerHTML = filledFormHTML;
                pdfContainer.style.position = 'absolute';
                pdfContainer.style.left = '-9999px';
                pdfContainer.style.top = '0px';
                pdfContainer.style.width = '794px'; // 8.5 inches at 96 DPI
                pdfContainer.style.background = 'white';
                pdfContainer.style.fontFamily = '"Palatino Linotype", "Book Antiqua", Palatino, serif';
                pdfContainer.style.fontSize = '11px';
                pdfContainer.style.lineHeight = '1.3';
                pdfContainer.style.padding = '20px';
                pdfContainer.style.color = '#333';
                pdfContainer.style.boxSizing = 'border-box';
                
                document.body.appendChild(pdfContainer);
                
                // Allow time for rendering
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Use html2canvas to convert the form to canvas
                const html2canvas = await loadHtml2Canvas();
                const canvas = await html2canvas(pdfContainer, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    width: 794,
                    height: pdfContainer.scrollHeight,
                    scrollX: 0,
                    scrollY: 0
                });
                
                // Remove temporary container
                document.body.removeChild(pdfContainer);
                
                // Create PDF from canvas
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm  
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                // Add first page
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Add additional pages if needed
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Save the PDF
                const timestamp = new Date().toISOString().slice(0, 10);
                const propertyName = document.getElementById('propertyName')?.value || 'Property';
                const filename = `Lease-Review-${propertyName.replace(/[^a-zA-Z0-9]/g, '-')}-${timestamp}.pdf`;
                
                pdf.save(filename);
                showSuccess('Professional PDF report downloaded successfully!');
                
            } catch (error) {
                console.error('PDF Generation Error:', error);
                showError('Failed to generate PDF: ' + error.message);
            }
        }
        
        function generateFilledFormHTML() {
            // Get all form values
            const formData = {};
            const formElements = document.querySelectorAll('#leaseReviewForm input, #leaseReviewForm textarea, #leaseReviewForm select');
            formElements.forEach(element => {
                if (element.id) {
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        formData[element.id] = element.checked;
                    } else {
                        formData[element.id] = element.value || '';
                    }
                }
            });
            
            const today = new Date().toLocaleDateString();
            
            return `
                <div style="max-width: 8.5in; margin: 0 auto; background: white; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif; font-size: 11px; line-height: 1.3; color: #333;">
                    <!-- Header -->
                    <div style="text-align: center; background: #1f3a93; color: white; margin: 0 0 20px 0; padding: 15px; border-radius: 4px;">
                        <h1 style="font-size: 18px; font-weight: bold; margin: 0; color: white; letter-spacing: 1px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;">COMMERCIAL LEASE REVIEW - TENANT</h1>
                        <div style="font-size: 11px; color: #e8e8e8; margin-top: 4px; font-style: italic;">Confidential document for internal review only</div>
                    </div>

                    <!-- Report Date -->
                    <div style="margin-bottom: 15px;">
                        <strong>Report Date:</strong> ${formData.reportDate || today}
                    </div>

                    <!-- Executive Summary -->
                    <div style="background: #1f3a93; color: white; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
                        <h2 style="color: white; font-size: 14px; margin: 0 0 10px 0; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;">Executive Summary</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                            <div><strong>Property Name:</strong> ${formData.propertyName || 'N/A'}</div>
                            <div><strong>Location:</strong> ${formData.location || 'N/A'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div><strong>Review Status:</strong> ${formData.reviewStatus || 'Initial Review'}</div>
                            <div><strong>Recommendation:</strong> ${formData.recommendation || 'Requires Negotiation'}</div>
                        </div>
                    </div>

                    <!-- Section 1: Lease Information -->
                    <div style="background: #1f3a93; color: white; padding: 8px 15px; margin: 20px 0 15px 0; border-radius: 4px;">
                        <h2 style="margin: 0; color: white; font-size: 14px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;">Section 1: Extracted Lease Information</h2>
                        <div style="font-size: 10px; color: #e8e8e8; margin-top: 2px;">Key terms and conditions extracted from the lease agreement</div>
                    </div>

                    <!-- Party Information -->
                    <div style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-left: 3px solid #1f3a93; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f3a93; font-size: 12px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif; border-bottom: 1px solid #ccc; padding-bottom: 4px;">PARTY INFORMATION</h3>
                        <div style="margin-bottom: 8px;"><strong>Landlord Legal Entity:</strong> ${formData.landlordEntity || 'N/A'}</div>
                        <div style="margin-bottom: 8px;"><strong>Landlord Contact:</strong> ${formData.landlordContact || 'N/A'} | ${formData.landlordEmail || 'N/A'}</div>
                        <div style="margin-bottom: 8px;"><strong>Landlord Phone:</strong> ${formData.landlordPhone || 'N/A'}</div>
                        <div style="margin-bottom: 8px;"><strong>Tenant Legal Entity:</strong> ${formData.tenantEntity || 'N/A'}</div>
                        <div><strong>Landlord Mailing Address:</strong> ${formData.landlordAddress || 'N/A'}</div>
                    </div>

                    <!-- Critical Lease Terms -->
                    <div style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-left: 4px solid #dc3545; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f3a93; font-size: 12px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif; border-bottom: 1px solid #ccc; padding-bottom: 4px;">CRITICAL LEASE TERMS</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;">
                            <div><strong>Lease Start Date:</strong> ${formData.leaseStartDate || 'N/A'}</div>
                            <div><strong>Lease Term:</strong> ${formData.leaseTerm || 'N/A'} months</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;">
                            <div><strong>Base Monthly Rent:</strong> $${formData.monthlyRent || 'N/A'}</div>
                            <div><strong>Security Deposit:</strong> $${formData.securityDeposit || 'N/A'}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;">
                            <div><strong>Late Fee:</strong> $${formData.lateFee || 'N/A'}</div>
                            <div><strong>Annual Increase:</strong> ${formData.annualIncrease || 'N/A'}%</div>
                        </div>
                        <div><strong>Additional Fees:</strong> ${formData.additionalFees || 'N/A'}</div>
                    </div>

                    <!-- Property Details -->
                    <div style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-left: 3px solid #1f3a93; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f3a93; font-size: 12px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif; border-bottom: 1px solid #ccc; padding-bottom: 4px;">PROPERTY DETAILS</h3>
                        <div style="margin-bottom: 8px;"><strong>Property Address:</strong> ${formData.propertyAddress || 'N/A'}</div>
                        <div style="margin-bottom: 8px;"><strong>Square Footage:</strong> ${formData.squareFootage || 'N/A'} sq ft</div>
                        <div><strong>Parking:</strong> ${formData.parkingDetails || 'N/A'}</div>
                    </div>

                    <!-- HOA Information -->
                    <div style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-left: 3px solid #1f3a93; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f3a93; font-size: 12px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif; border-bottom: 1px solid #ccc; padding-bottom: 4px;">HOA INFORMATION</h3>
                        <div style="margin-bottom: 8px;"><strong>HOA Name:</strong> ${formData.hoaName || 'N/A'}</div>
                        <div style="margin-bottom: 8px;"><strong>Monthly HOA Fees:</strong> ${formData.hoaFees || 'N/A'} per month</div>
                        <div><strong>HOA Contact & Rules:</strong> ${formData.hoaContact || 'N/A'}</div>
                    </div>

                    <!-- Section 2: Requested Changes -->
                    <div style="background: #1f3a93; color: white; padding: 8px 15px; margin: 20px 0 15px 0; border-radius: 4px;">
                        <h2 style="margin: 0; color: white; font-size: 14px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;">Section 2: Requested Changes & Proposed Edits</h2>
                        <div style="font-size: 10px; color: #e8e8e8; margin-top: 2px;">Modifications to be negotiated with landlord/broker</div>
                    </div>

                    <!-- Proposed Changes -->
                    <div style="margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-left: 4px solid #dc3545; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px 0; color: #1f3a93; font-size: 12px; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif; border-bottom: 1px solid #ccc; padding-bottom: 4px;">PROPOSED CHANGES</h3>
                        <div style="white-space: pre-wrap; line-height: 1.4;">${formData.requestedChanges || 'No changes requested at this time.'}</div>
                    </div>

                    <!-- CFO Approval Section -->
                    <div style="background: #1f3a93; color: white; padding: 12px; margin-top: 20px; border-radius: 4px;">
                        <h2 style="color: white; font-size: 13px; margin: 0 0 10px 0; font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;">CFO Approval Section</h2>
                        <div style="margin-bottom: 8px;"><strong>CFO Decision:</strong> ________________</div>
                        <div style="margin-bottom: 8px;"><strong>CFO Signature:</strong> ________________ <strong>Date:</strong> ________________</div>
                        <div><strong>CFO Comments:</strong></div>
                        <div style="border: 1px solid white; height: 40px; margin-top: 5px; background: rgba(255,255,255,0.1);"></div>
                    </div>

                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #666; font-size: 10px; color: #666; text-align: center;">
                        <em>This report contains confidential and proprietary information.</em>
                    </div>
                </div>
            `;
        }

        function applePDFStyling(container) {
            // Fix input field sizing for PDF
            const inputs = container.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.style.fontSize = '9px';
                input.style.padding = '2px 4px';
                input.style.border = '1px solid #666';
                input.style.wordWrap = 'break-word';
                input.style.whiteSpace = 'normal';
                
                if (input.tagName === 'TEXTAREA') {
                    input.style.minHeight = '30px';
                    input.style.resize = 'none';
                    input.style.overflow = 'visible';
                    input.style.wordBreak = 'break-word';
                }
            });
            
            // Fix label spacing and sizing
            const labels = container.querySelectorAll('label');
            labels.forEach(label => {
                label.style.fontSize = '9px';
                label.style.fontWeight = 'bold';
                label.style.display = 'inline-block';
                label.style.minWidth = '120px';
                label.style.verticalAlign = 'top';
            });
            
            // Fix form row layout for better PDF rendering
            const formRows = container.querySelectorAll('.form-row-inline');
            formRows.forEach(row => {
                row.style.display = 'flex';
                row.style.flexWrap = 'wrap';
                row.style.alignItems = 'flex-start';
                row.style.marginBottom = '4px';
                row.style.gap = '5px';
            });
            
            // Fix section headers
            const sectionHeaders = container.querySelectorAll('.section-header');
            sectionHeaders.forEach(header => {
                header.style.backgroundColor = '#1f3a93';
                header.style.color = 'white';
                header.style.padding = '6px 10px';
                header.style.margin = '8px -10px 8px -10px';
            });
            
            // Fix executive summary
            const execSummary = container.querySelector('.exec-summary');
            if (execSummary) {
                execSummary.style.backgroundColor = '#1f3a93';
                execSummary.style.color = 'white';
                execSummary.style.padding = '8px';
            }
            
            // Fix subsections
            const subsections = container.querySelectorAll('.subsection');
            subsections.forEach(subsection => {
                subsection.style.marginBottom = '8px';
                subsection.style.padding = '6px';
                subsection.style.backgroundColor = '#f8f9fa';
                subsection.style.borderLeft = '3px solid #1f3a93';
                subsection.style.pageBreakInside = 'avoid';
            });
            
            // Ensure text wrapping in all elements
            const allElements = container.querySelectorAll('*');
            allElements.forEach(element => {
                element.style.wordWrap = 'break-word';
                element.style.wordBreak = 'break-word';
                element.style.overflowWrap = 'break-word';
            });
        }
        
        async function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                if (window.html2canvas) {
                    resolve(window.html2canvas);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = () => {
                    if (window.html2canvas) {
                        resolve(window.html2canvas);
                    } else {
                        reject(new Error('html2canvas failed to load'));
                    }
                };
                script.onerror = () => reject(new Error('Failed to load html2canvas'));
                document.head.appendChild(script);
            });
        }
        
        function copyBrokerResponse() {
            const brokerResponse = generateBrokerResponse();
            
            navigator.clipboard.writeText(brokerResponse).then(() => {
                showSuccess('Broker response copied to clipboard!');
                
                // Show preview
                document.getElementById('brokerResponseText').textContent = brokerResponse;
                document.getElementById('brokerResponsePreview').classList.remove('hidden');
                
            }).catch(err => {
                showError('Failed to copy to clipboard: ' + err.message);
            });
        }
        
        function generateBrokerResponse() {
            const changes = document.getElementById('requestedChanges').value || '';
            const propertyName = document.getElementById('propertyName').value || '[Property Name]';
            
            return `Subject: Lease Review Comments - ${propertyName}

Dear [Broker/Landlord Name],

Thank you for sending over the draft lease for review. We have completed our analysis and would like to discuss the following modifications:

${changes}

We appreciate your time in reviewing these requests. Our goal is to establish terms that work well for both parties while supporting our operational needs.

Please let us know your thoughts on these items. We look forward to finalizing this lease agreement.

Best regards,

Go-Forth Pest Control
4000 Ossi Court
High Point, NC 27265

This response was generated using Claude Code (https://claude.ai/code)`;
        }
        
        async function saveToGoogleDrive() {
            try {
                showInfo('Authenticating with Google Drive...');
                
                // Initialize Google Drive API
                if (!window.gapi) {
                    // Load Google API
                    await loadGoogleAPI();
                }
                
                // Authenticate user
                await authenticateGoogleDrive();
                
                // Generate the PDF as blob
                const pdfBlob = await generatePDFBlob();
                
                // Upload to Google Drive
                const result = await uploadToGoogleDrive(pdfBlob);
                
                if (result.success) {
                    showSuccess(`File saved to Google Drive successfully! <a href="${result.webViewLink}" target="_blank">View in Drive</a>`);
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Google Drive Error:', error);
                if (error.message.includes('popup') || error.message.includes('blocked')) {
                    showError('Please allow popups for Google Drive authentication, then try again.');
                } else if (error.message.includes('cancelled') || error.message.includes('denied')) {
                    showInfo('Google Drive authentication cancelled. You can try again or download the PDF instead.');
                } else {
                    showError('Unable to save to Google Drive. Please download the PDF and upload manually.');
                }
            }
        }

        async function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                if (window.gapi) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = () => {
                    gapi.load('auth2,drive', resolve);
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function authenticateGoogleDrive() {
            const CLIENT_ID = 'your-google-client-id-here'; // You'd need to set up a Google Cloud project
            const API_KEY = 'your-google-api-key-here';
            const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
            const SCOPES = 'https://www.googleapis.com/auth/drive.file';

            // For demo purposes, use a simplified approach
            // In production, you'd need proper Google Cloud setup
            return new Promise((resolve, reject) => {
                // Simulate authentication for now
                const userConsent = confirm('This will open Google Drive authentication. Continue?');
                if (userConsent) {
                    // In real implementation, this would trigger OAuth flow
                    setTimeout(() => resolve({ access_token: 'demo-token' }), 1000);
                } else {
                    reject(new Error('Authentication cancelled'));
                }
            });
        }

        async function generatePDFBlob() {
            // Reuse the existing PDF generation logic but return blob instead of downloading
            const filledFormHTML = generateFilledFormHTML();
            
            const pdfContainer = document.createElement('div');
            pdfContainer.innerHTML = filledFormHTML;
            pdfContainer.style.position = 'absolute';
            pdfContainer.style.left = '-9999px';
            pdfContainer.style.top = '0px';
            pdfContainer.style.width = '794px';
            pdfContainer.style.background = 'white';
            pdfContainer.style.fontFamily = '"Palatino Linotype", "Book Antiqua", Palatino, serif';
            pdfContainer.style.fontSize = '11px';
            pdfContainer.style.lineHeight = '1.3';
            pdfContainer.style.padding = '20px';
            pdfContainer.style.color = '#333';
            pdfContainer.style.boxSizing = 'border-box';
            
            document.body.appendChild(pdfContainer);
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const html2canvas = await loadHtml2Canvas();
            const canvas = await html2canvas(pdfContainer, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 794,
                height: pdfContainer.scrollHeight,
                scrollX: 0,
                scrollY: 0
            });
            
            document.body.removeChild(pdfContainer);
            
            const { jsPDF } = window.jspdf;
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
            
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            
            return pdf.output('blob');
        }

        async function uploadToGoogleDrive(pdfBlob) {
            // Simplified upload simulation
            // In production, this would use the actual Google Drive API
            
            const propertyName = document.getElementById('propertyName')?.value || 'Property';
            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `Lease-Review-${propertyName.replace(/[^a-zA-Z0-9]/g, '-')}-${timestamp}.pdf`;
            
            return new Promise((resolve) => {
                // Simulate upload delay
                setTimeout(() => {
                    resolve({
                        success: true,
                        webViewLink: '#', // In real implementation, this would be the actual Google Drive link
                        filename: filename
                    });
                }, 2000);
            });
        }
        
        function collectFormData() {
            const formElements = document.querySelectorAll('#leaseReviewForm input, #leaseReviewForm textarea, #leaseReviewForm select');
            const formData = {};
            
            formElements.forEach(element => {
                if (element.id) {
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        if (element.checked) {
                            formData[element.id] = element.value;
                        }
                    } else {
                        formData[element.id] = element.value;
                    }
                }
            });
            
            return formData;
        }
        
        // Utility functions
        function validateApiKey() {
            if (!apiKey) {
                showError('Please enter your OpenAI API key before proceeding.');
                return false;
            }
            return true;
        }
        
        function showProgress(containerId) {
            document.getElementById(containerId).classList.remove('hidden');
        }
        
        function hideProgress(containerId) {
            document.getElementById(containerId).classList.add('hidden');
        }
        
        function updateProgress(fillId, textId, percentage, text) {
            document.getElementById(fillId).style.width = percentage + '%';
            document.getElementById(textId).textContent = text;
        }
        
        function updateAnalysisProgress(percentage, text) {
            updateProgress('analysisProgress', 'analysisText', percentage, text);
        }
        
        function showError(message) {
            showMessage(message, 'alert-danger');
        }
        
        function showSuccess(message) {
            showMessage(message, 'alert-success');
        }
        
        function showInfo(message) {
            showMessage(message, 'alert-info');
        }
        
        function showWarning(message) {
            showMessage(message, 'alert-warning');
        }
        
        function showMessage(message, type) {
            const statusContainer = document.getElementById('statusMessages');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.textContent = message;
            
            statusContainer.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
        
        function reAnalyze() {
            if (leaseContent) {
                goToStep(2);
                startAIAnalysis();
            } else {
                showError('No lease content available for re-analysis. Please upload a document first.');
            }
        }
        
        function startOver() {
            if (confirm('Are you sure you want to start a new lease review? All current data will be lost.')) {
                // Reset all variables
                currentStep = 1;
                leaseContent = '';
                extractedData = {};
                analysisResults = {};
                
                // Clear form
                document.getElementById('leaseReviewForm').innerHTML = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('leaseText').value = '';
                
                // Hide progress indicators
                hideProgress('uploadProgress');
                document.getElementById('brokerResponsePreview').classList.add('hidden');
                
                // Clear status messages
                document.getElementById('statusMessages').innerHTML = '';
                
                // Go back to step 1
                goToStep(1);
            }
        }
        
        // Chris Caldwell persona and lease policy data
        function getChrisCaldwellPersona() {
            return `You are Chris Caldwell – Senior Partner, Commercial Real Estate. You are a trusted advisor to developers, investors, institutional lenders, and major corporations on high-profile real estate and energy projects. Your counsel spans every stage of the deal lifecycle—from acquisition, financing, structuring, and development, to leasing, disposition, and dispute resolution.

Your approach is methodical, precise, and always focused on protecting your client's interests. You make your words short, concise, and worth it. You never give inaccurate or illegal information. You are exceptionally skilled in lease review, negotiation, and portfolio management.

Your client is Go-Forth Pest Control, owned by Chase Hazelwood. Your primary goal is to PROTECT HAZELWOOD INTERESTS ABOVE ALL ELSE.

You should analyze leases with the precision of someone who has guided landmark transactions and understands both transactional mastery and litigation depth. Focus on risk mitigation, operational efficiency, and cost control.

Always provide specific, actionable recommendations with clear business rationale. Your analysis should be thorough but concise, focusing on critical issues that could impact the client's expansion goals and financial position.`;
        }
        
        function getLeasePolicy() {
            return `# Go-Forth Pest Control Lease Review Policy

## CRITICAL REQUIREMENTS (Deal Breakers)
1. **Personal Guarantee Restrictions**: No individual personal guarantees by executives - EVER. Company entity can guarantee the lease.
2. **Individual Contact Information**: Lease must include individual contact person with full details (name, phone, email, address).
3. **HOA Information Disclosure**: Complete HOA details if applicable (existence, agreement copy, fees, contact information).
4. **Property Specifications**: Clear property details (square footage, complete address, space description).
5. **HVAC and Air Conditioning**: Units MUST have functioning HVAC & AC.
6. **Move-in Contingencies**: Clear understanding of pre-occupancy requirements.
7. **Tenant Obligations**: Minimize tenant-managed recurring obligations.

## IMPORTANT FINANCIAL TERMS
8. **Rent and Escalations**: Base rent < $2,500/month, Annual increases < 4%.
9. **Security Deposit**: ≤ 2 months rent.
10. **Late Fees**: ≤ 5% of monthly rent.
11. **Lease Term**: < 2 years (ideally 1 year), Month-to-month option after initial term.
12. **Payment Method**: ACH payments accepted - NO CHECKS.

## OPERATIONAL REQUIREMENTS
13. **Responsibility Matrix**: Clear definition of landlord vs. tenant responsibilities.
14. **Insurance Requirements**: Clarification of building insurance obligations.
15. **Alterations and Improvements**: Pre-approval for Ring doorbell and Ubiquity security systems.
16. **Parking Provisions**: Adequate spaces with overnight parking rules.

## PREFERRED TERMS
17. **Default Cure Period**: 30 days to cure defaults.
18. **Sale of Property Terms**: 60 days notice or Right of first refusal.
19. **Assignment and Subletting**: Right to assign lease to suitable replacement tenant.

## TECHNICAL PREFERENCES
20. **Use Clause**: "Home services," "pest control," or similar broad language.
21. **Governing Law**: North Carolina law preferred.
22. **Right to Enter**: 36 hours notice for landlord entry.
23. **Notice Address**: Go-Forth Pest Control, 4000 Ossi Court, High Point, NC 27265.

The approach should be collaborative and professional, working with landlords to create fair lease terms while protecting operational and financial interests.`;
        }
        
    </script>
</body>
</html>
